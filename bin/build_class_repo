#!/usr/bin/ruby

if ARGV.length != 1
  puts "Usage: bin/build_class_repo <GITHUB_REPOSITORY_URL>"
  puts "  e.g. bin/build_class_repo git@github.com:torqueforge/poodl-2014-june.git"
  exit 1
end

class_repo   = ARGV.pop
class_name   = class_repo.split("/").last.split('.').first
initial_dir  = `pwd`
template_dir = 'exercises'

# move to the parent directory
if initial_dir.strip.split('/').last == template_dir
  Dir.chdir('..')
end

# in case the last cleanup failed
puts "\n==========\nCleaning up debris\n==========\n"
`rm -rf #{template_dir}_bare`

# Make a bare repo of the template_repo on github and then
# push a mirror of the template into the new class repo.
# Note: This assumes that you've created the new class repo on github.
#       Do not initialize your new repo with a readme.

puts "\n==========\nCreating a bare clone of #{template_dir}\n==========\n"
`git clone --bare https://github.com/torqueforge/#{template_dir}.git #{template_dir}_bare`
Dir.chdir("#{template_dir}_bare")

puts "\n==========\nPushing a mirror to #{class_repo}\n==========\n"
`git push --mirror #{class_repo}`
Dir.chdir('..')

puts "\n==========\nRemoving bare clone of #{template_dir}\n==========\n"
`rm -rf #{template_dir}_bare`

# Now that the new class repo exists, clone it and
# tweek a few things.

puts "\n==========\nCloning #{class_repo}\n==========\n"
`git clone #{class_repo}`

puts "\n==========\nTweaking #{class_repo}\n==========\n"
Dir.chdir(class_name)

`sed -i.bak 's/$NAME_OF_CLASS/#{class_name}/g' README.md`
`rm README.md.bak`
`git add README.md`
`git rm CLASS_SETUP.md`
`git rm -r bin`
`git commit -m 'Create repo for $NAME_OF_CLASS'`

puts "\n==========\nPusing tweaked #{class_repo}\n==========\n"
`git push origin master`
